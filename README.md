# SDUI ç‰©ç†äº¤äº’ç»ˆç«¯ç³»ç»Ÿ (ESP32-S3) å¼€å‘æŒ‡å—

## ä¸€ã€ é¡¹ç›®èƒŒæ™¯ä¸æ€»ä½“ç›®æ ‡

æœ¬é¡¹ç›®æ„å»ºäº†ä¸€ä¸ªåŸºäºâ€œç˜¦å®¢æˆ·ç«¯ï¼ˆThin Clientï¼‰â€æ¶æ„çš„åˆ†å¸ƒå¼ç‰©è”ç½‘äº¤äº’ç³»ç»Ÿã€‚ç³»ç»Ÿå°† ESP32-S3 å¾®æ§åˆ¶å™¨æŠ½è±¡ä¸ºçº¯ç²¹çš„ç‰©ç† I/O èŠ‚ç‚¹ï¼Œè´Ÿè´£ç¯å¢ƒæ„ŸçŸ¥ã€æµåª’ä½“é‡‡é›†ä¸ UI æ¸²æŸ“ã€‚

æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ã€çŠ¶æ€åŒæ­¥ã€åª’ä½“è§£æåŠ AI äº¤äº’å‡ç”±è¿œç«¯ Python æœåŠ¡å™¨æ¥ç®¡ã€‚ç»ˆç«¯ä¸æœåŠ¡å™¨ä¹‹é—´é€šè¿‡åŸºäºä¸»é¢˜è·¯ç”±çš„ **SDUI (Server-Driven UI) äº¤äº’åè®®**åŠå…¨åŒå·¥ WebSocket é€šé“è¿›è¡Œé«˜é€Ÿé€šä¿¡ã€‚

---

## äºŒã€ ç³»ç»Ÿæ¶æ„ä¸å·¥ç¨‹ç»“æ„

ç³»ç»Ÿåœ¨é€»è¾‘ä¸ç‰©ç†å±‚é¢åˆ’åˆ†ä¸ºä¸¤å¤§æ ¸å¿ƒéƒ¨åˆ†ï¼š

1. **ç‰©ç†ç»ˆç«¯å±‚ (ESP32-S3)**ï¼šä¾æ‰˜ ESP-IDF (v5.5) æ¡†æ¶ï¼Œå®ç°ç¡¬ä»¶æ€»çº¿é©±åŠ¨ã€LVGL æ¸²æŸ“å¼•æ“ã€éŸ³é¢‘åŒå·¥ç³»ç»ŸåŠæ¶ˆæ¯æ€»çº¿è·¯ç”±ã€‚
2. **äº‘ç«¯ä¸šåŠ¡å±‚ (Python Server)**ï¼šå¼‚æ­¥éé˜»å¡ç½‘å…³ï¼Œè´Ÿè´£ STT (Speech-To-Text) è§£æã€éŸ³é¢‘æŒä¹…åŒ–è°ƒè¯•ã€UI çŠ¶æ€ç»´æŠ¤åŠåª’ä½“åˆ‡ç‰‡ä¸‹å‘ã€‚

### ç›®å½•ç»“æ„

ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–ç»„ä»¶è®¾è®¡ï¼Œé€šè¿‡ CMake è¿›è¡Œä¾èµ–ç®¡ç†ï¼š

```text
02_lvgl_demo_v9/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ sdui_bus/           # æ ¸å¿ƒæ¢çº½ï¼šåŸºäº Pub/Sub æ¨¡å¼çš„æ¶ˆæ¯è·¯ç”±æ€»çº¿ (ä¸Šè¡Œ + æœ¬åœ°äº‹ä»¶)
â”‚   â”œâ”€â”€ sdui_parser/        # å¸ƒå±€å¼•æ“ï¼šJSON â†’ LVGL é€’å½’æ¸²æŸ“ã€Action URI äº‹ä»¶ç»‘å®š
â”‚   â”œâ”€â”€ websocket_manager/  # é€šä¿¡åº•åº§ï¼šè´Ÿè´£é“¾è·¯ç»´æŠ¤ã€æ–­çº¿é‡è¿ä¸é•¿è½½è·åˆ†å—æ‹¼æ¥
â”‚   â”œâ”€â”€ audio_manager/      # åª’ä½“å¼•æ“ï¼šéŸ³é¢‘é©±åŠ¨ (ES8311/ES7210)ã€ç”µæºç®¡ç†ä¸ Base64 ç¼–è§£ç 
â”‚   â”œâ”€â”€ imu_manager/        # ç©ºé—´æ„ŸçŸ¥ï¼šQMI8658/QMA7981 ä¼ æ„Ÿå™¨é©±åŠ¨åŠå§¿æ€ç®—æ³•
â”‚   â”œâ”€â”€ wifi_manager/       # ç½‘ç»œè®¾æ–½ï¼šWi-Fi STA çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ telemetry_manager/  # é¥æµ‹ä¸ŠæŠ¥ï¼šè®¾å¤‡å”¯ä¸€ç ã€WiFi RSSI/IPã€èŠ¯ç‰‡æ¸©åº¦ã€å †å†…å­˜å®šæ—¶ä¸ŠæŠ¥
â”‚   â””â”€â”€ esp32_s3_touch_amoled_1_75c/ # BSPï¼šå±å¹•åŠè§¦æ‘¸é©±åŠ¨åº•å±‚æ”¯æŒ
â”œâ”€â”€ main/
â”‚   â””â”€â”€ main.c              # ä¸šåŠ¡å…¥å£ï¼šåˆå§‹åŒ–è°ƒåº¦ã€åŠ¨æ€ SDUI å¸ƒå±€å…¥å£ä¸æ¯å±ç®¡ç†
â”œâ”€â”€ sdkconfig.defaults      # ç³»ç»Ÿæ ¸å¿ƒé…ç½®ï¼ˆå†…å­˜åˆ†å¸ƒã€é¢‘ç‡ã€å¤–è®¾å®ç­‰ï¼‰
â””â”€â”€ CMakeLists.txt          
```

---

## ä¸‰ã€ SDUI äº¤äº’åè®® (Topic-Based)

ç³»ç»Ÿé€šä¿¡ç»Ÿä¸€é‡‡ç”¨åŸºäºâ€œä¸»é¢˜-è½½è·ï¼ˆTopic-Payloadï¼‰â€ç»“æ„çš„ JSON åè®®ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘çš„é«˜åº¦è§£è€¦ã€‚

### 3.1 ä¸Šè¡Œé“¾è·¯ (ç»ˆç«¯ -> äº‘ç«¯)

> **æ‰€æœ‰ä¸Šè¡Œæ¶ˆæ¯å‡åœ¨ä¿¡å°é¡¶å±‚è‡ªåŠ¨æºå¸¦ `device_id`ï¼ˆeFuse MACï¼‰ï¼ŒæœåŠ¡å™¨å¯ç›´æ¥ä»ä»»æ„æ¶ˆæ¯ä¸­è¯†åˆ«æ¥æºç»ˆç«¯ã€‚**

| ä¸»é¢˜ (Topic) | è½½è·ç¤ºä¾‹ (Payload) | è§¦å‘åœºæ™¯ä¸è¯´æ˜ |
| --- | --- | --- |
| `ui/click` | `{"id": "btn_1"}` | å±å¹•åŸå­æŒ‰é’®è§¦æ§äº‹ä»¶ï¼ˆé»˜è®¤ Action URIï¼‰ã€‚ |
| `audio/record` | `{"state": "stream", "data": "..."}` | å½•éŸ³å¼€å¯/åœæ­¢ä¿¡å·åŠ PCM è½¬ Base64 éŸ³é¢‘æ•°æ®æµã€‚ |
| `motion` | `{"type": "shake", "magnitude": 15.3}` | IMU è¯†åˆ«åˆ°çš„ç‰©ç†å§¿æ€å˜åŒ–ï¼ˆå¦‚æ‘‡ä¸€æ‘‡ï¼‰ã€‚ |
| `telemetry/heartbeat` | `{"wifi_rssi":-65, "ip":"192.168.1.5", "temperature":42.5, "free_heap_internal":45000, "free_heap_total":3500000, "uptime_s":120}` | **è®¾å¤‡é¥æµ‹å¿ƒè·³**ï¼šæ¯ 30 ç§’å®šæ—¶ä¸ŠæŠ¥ï¼ŒæœåŠ¡å™¨ä»¥ `device_id` ä¸º key ç®¡ç†ç»ˆç«¯æ³¨å†Œè¡¨ã€‚ |

**å®Œæ•´ä¸Šè¡Œä¿¡å°æ ¼å¼**ï¼ˆ`device_id` ç”± `sdui_bus` ç»Ÿä¸€è‡ªåŠ¨æ³¨å…¥ï¼Œå„ä¸šåŠ¡æ¨¡å—æ— æ„ŸçŸ¥ï¼‰ï¼š

```json
{
  "topic":     "ui/click",
  "device_id": "1020BA3D35D0",
  "payload":   {"id": "btn_add"}
}
```


### 3.2 ä¸‹è¡Œé“¾è·¯ (äº‘ç«¯ -> ç»ˆç«¯)

| ä¸»é¢˜ (Topic) | è½½è·ç¤ºä¾‹ (Payload) | æ‰§è¡ŒåŠ¨ä½œä¸è¯´æ˜ |
| --- | --- | --- |
| `ui/layout` | `{"flex":"column", "children":[...]}` | **å…¨é‡å¸ƒå±€æ¸²æŸ“**ï¼šæ¸…é™¤ç°æœ‰ UI å¹¶æ ¹æ® JSON æ ‘é€’å½’æ„å»ºæ–°ç•Œé¢ã€‚ |
| `ui/update` | `{"id":"label_1","text":"Count: 5"}` | **å¢é‡å±æ€§æ›´æ–°**ï¼šæŒ‰ ID æŸ¥æ‰¾ç»„ä»¶å¹¶æ›´æ–°å…¶å±æ€§ã€‚ |
| `audio/play` | `"UklG..."` | ç»ˆç«¯æ¥æ”¶ Base64 éŸ³é¢‘åˆ‡ç‰‡ï¼Œå³æ—¶è§£ç å¹¶æ¨å…¥ I2S æ‰¬å£°å™¨ã€‚ |

### 3.3 å®¹å™¨åŒ–å¸ƒå±€ JSON åè®® (ui/layout)

Server ä¸‹å‘çš„ `ui/layout` è½½è·ä¸ºæ ‘çŠ¶ JSON ç»“æ„ï¼Œæ”¯æŒä»¥ä¸‹åŸå­ç»„ä»¶ä¸å±æ€§ï¼š

| å±æ€§ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
| --- | --- | --- | --- |
| `type` | string | ç»„ä»¶ç±»å‹: `container` / `label` / `button` / `image` / `bar` / `slider` / `particle` | `"type": "bar"` |
| `id` | string | ç»„ä»¶å”¯ä¸€ IDï¼Œç”¨äº `ui/update` å¢é‡æ›´æ–° | `"id": "btn_rec"` |
| `text` | string | æ–‡æœ¬å†…å®¹ (label/button) | `"text": "Hold to Talk"` |
| `flex` | string | Flex å¸ƒå±€æ–¹å‘: `row` / `column` / `row_wrap` / `column_wrap` | `"flex": "column"` |
| `justify` | string | ä¸»è½´å¯¹é½: `start` / `center` / `end` / `space_between` | `"justify": "center"` |
| `align_items` | string | äº¤å‰è½´å¯¹é½ | `"align_items": "center"` |
| `scrollable` | boolean | å®¹å™¨å¯ç”¨è§¦æ‘¸æ»šåŠ¨ (container ä¸“ç”¨) | `"scrollable": true` |
| `w` / `h` | number/string | å°ºå¯¸ï¼šåƒç´  `120`ã€ç™¾åˆ†æ¯” `"50%"`ã€`"full"` / `"content"` | `"w": "80%"` |
| `align` | string | ç»å¯¹å®šä½: `center` / `top_mid` / `bottom_mid` ç­‰ | `"align": "center"` |
| `bg_color` | string | èƒŒæ™¯è‰² (Hex) | `"bg_color": "#2ecc71"` |
| `text_color` | string | æ–‡å­—é¢œè‰² (Hex) | `"text_color": "#FFFFFF"` |
| `font_size` | number | å­—ä½“å¤§å°ï¼Œæ˜ å°„åˆ° Montserrat 14/16/20/24/26 | `"font_size": 24` |
| `gap` | number | Flex å­å…ƒç´ é—´è· | `"gap": 10` |
| `pad` / `radius` | number | å†…è¾¹è· / åœ†è§’ | `"pad": 8` |
| `shadow_w` / `shadow_color` | number/string | é˜´å½±å®½åº¦ / é˜´å½±é¢œè‰² | `"shadow_w": 6` |
| `opa` | number | æ•´ä½“ä¸é€æ˜åº¦ (0â€“255) | `"opa": 180` |
| `hidden` | boolean | éšè—/æ˜¾ç¤º | `"hidden": true` |
| `long_mode` | string | label é•¿æ–‡æœ¬: `wrap` / `scroll` / `dot` / `marquee` | `"long_mode": "marquee"` |
| `anim` | object | åŠ¨ç”»æè¿°å¯¹è±¡ï¼Œè§ 3.6 èŠ‚ | `"anim": {"type": "blink"}` |
| `children` | array | å­ç»„ä»¶æ•°ç»„ | `"children": [...]` |

### 3.4 Action URI äº‹ä»¶ç»‘å®šåè®®

æ¯ä¸ªäº¤äº’ç»„ä»¶å¯é€šè¿‡ `on_click` / `on_press` / `on_release` å­—æ®µç»‘å®šåŠ¨ä½œï¼š

| URI å‰ç¼€ | è·¯ç”±æ–¹å¼ | ç¤ºä¾‹ |
| --- | --- | --- |
| `local://` | æœ¬åœ°æ€»çº¿åˆ†å‘ï¼Œä¸ç» WebSocket | `"on_press": "local://audio/cmd/record_start"` |
| `server://` | é€šè¿‡ WebSocket ä¸ŠæŠ¥äº‘ç«¯ | `"on_click": "server://ui/action"` |
| æ— å‰ç¼€ | é»˜è®¤ä¸ŠæŠ¥ `ui/click` | `"on_click": ""` (å‘é€ `{"id":"xxx"}`) |

**ç¤ºä¾‹ï¼šServer ä¸‹å‘â€œæŒ‰ä½è¯´è¯â€æŒ‰é’®**
```json
{
  "topic": "ui/layout",
  "payload": {
    "flex": "column", "justify": "center", "align_items": "center", "gap": 15,
    "children": [
      {"type": "label", "id": "status", "text": "Ready", "font_size": 20},
      {
        "type": "button", "id": "btn_rec", "text": "Hold to Talk",
        "w": 160, "h": 50, "bg_color": "#2ecc71",
        "on_press": "local://audio/cmd/record_start",
        "on_release": "local://audio/cmd/record_stop"
      }
    ]
  }
}
```
ç»ˆç«¯æ¸²æŸ“æŒ‰é’®åï¼ŒæŒ‰ä¸‹æ—¶è‡ªåŠ¨è§¦å‘æœ¬åœ° `audio_manager` å¼€å§‹å½•éŸ³ï¼Œæ¾æ‰‹åœæ­¢ï¼Œæ— éœ€ç»è¿‡äº‘ç«¯ã€‚

---

### 3.5 å¢å¼ºå‹åŸå­ç»„ä»¶

| ç»„ä»¶ç±»å‹ (`type`) | å…³é”®å±æ€§ | åŠŸèƒ½è¯´æ˜ |
| --- | --- | --- |
| `image` | `src`(Base64), `img_w`, `img_h`, `w`, `h`, `radius` | **æµå¼å›¾åƒç»„ä»¶**ï¼šBase64(RGB565) è§£ç ï¼Œå­˜äº PSRAMï¼Œæ”¯æŒ `spin` æ—‹è½¬åŠ¨ç”»ã€‚ |
| `bar` | `value`(0-100), `min`, `max`, `bg_color`, `indic_color` | **è¿›åº¦æ¡**ï¼šå±•ç¤ºæ’­æ”¾è¿›åº¦ã€ä¼ æ„Ÿå™¨é‡ç¨‹ï¼Œæ”¯æŒ `ui/update` åŠ¨ç”»æ›´æ–°ã€‚ |
| `slider` | `value`, `min`, `max`, `on_change` | **æ»‘åŠ¨æ§åˆ¶**ï¼šéŸ³é‡/äº®åº¦è°ƒèŠ‚ï¼Œæ‹–åŠ¨æ¾æ‰‹åé€šè¿‡ Action URI ä¸ŠæŠ¥å½“å‰å€¼ã€‚ |
| `particle` | `count`(â‰¤30), `color`, `particle_size`, `duration`(ms), `canvas_w`, `canvas_h` | **ç²’å­ç‰¹æ•ˆ**ï¼šPSRAM Canvas (æœ€å¤§200Ã—200Ã—2B=80KB)ï¼Œé‡åŠ›ç²’å­è¿½è¸ªã€‚ |

**`bar` æµå¼ç¤ºä¾‹ï¼ˆéŸ³ä¹æ’­æ”¾å†ï¼‰**ï¼š
```json
{
  "type": "bar", "id": "progress",
  "w": 280, "h": 6,
  "value": 35,
  "bg_color": "#2a2a2a",
  "indic_color": "#1db954",
  "radius": 3
}
```

**`slider` æµå¼ç¤ºä¾‹ï¼ˆéŸ³é‡è°ƒèŠ‚ï¼‰**ï¼š
```json
{
  "type": "slider", "id": "vol",
  "w": 240, "value": 70, "min": 0, "max": 100,
  "on_change": "server://ui/volume"
}
```

**`slider` ä¸ŠæŠ¥æ ¼å¼**ï¼š
```json
{"topic": "ui/volume", "device_id": "...", "payload": {"id": "vol", "value": 70}}
```

---

### 3.6 åŠ¨ç”»ç‰¹æ•ˆåè®® (anim å­—æ®µ)

ä»»æ„ç»„ä»¶å¯é™„åŠ å¯é€‰çš„ `anim` å¯¹è±¡ï¼ŒæœåŠ¡ç«¯åˆ©ç”¨æ­¤å­—æ®µé©±åŠ¨ç»ˆç«¯åŠ¨ç”»ï¼Œæ— éœ€ä¿®æ”¹å›ºä»¶ã€‚

| `anim.type` | å®ç°æœºåˆ¶ | å…³é”®å‚æ•° | å†…å­˜å¼€é”€ |
| --- | --- | --- | --- |
| `blink` | é€æ˜åº¦ 0â‡”255 è„‰å†² | `duration`(ms), `repeat`(-1=æ— é™) | ~60B |
| `breathe` | é€æ˜åº¦ min_opaâ‡”max_opa æ…¢é€Ÿè„‰å†² | `min_opa`, `max_opa`, `duration` | ~60B |
| `spin` | å›¾ç‰‡ 0â†’3600 å¾ªç¯æ—‹è½¬ (image ä¸“ç”¨, â‰¤ 2 ä¸ªå¹¶å‘) | `duration`, `direction`(cw/ccw) | ~60B |
| `slide_in` | translate å€ç§»å…¥åœºï¼ˆå•æ¬¡ï¼‰ | `from`(left/right/top/bottom), `duration` | ~60B |
| `shake` | x è½´å·¦å³æŠ–åŠ¨ï¼ˆå•æ¬¡ï¼‰ | `amplitude`(åƒç´ ), `duration` | ~60B |
| `color_pulse` | bg_color åŒè‰²æ¸å˜è„‰å†² | `color_a`(Hex), `color_b`(Hex), `duration`, `repeat` | ~120B |
| `marquee` | label åŸç”Ÿå¾ªç¯æ»šåŠ¨ (label ä¸“ç”¨) | æ—  | 0 |

**ç¤ºä¾‹ï¼šå½•éŸ³æŒ‰éˆ•ä¸å°é¢æ—‹è½¬**
```json
{
  "flex": "column", "align_items": "center", "gap": 20,
  "children": [
    {
      "type": "image", "id": "cover",
      "src": "<base64_rgb565_data>", "img_w": 120, "img_h": 120,
      "w": 120, "h": 120, "radius": 60,
      "anim": {"type": "spin", "duration": 8000, "direction": "cw"}
    },
    {"type": "label", "text": "æ­Œæ›²åç§°å™¨å§å—å¤´æ­Œæ­Œå”±ä¸­", "font_size": 14,
     "long_mode": "marquee", "w": 250},
    {
      "type": "bar", "id": "progress", "w": 280, "h": 6,
      "value": 35, "bg_color": "#2a2a2a", "indic_color": "#1db954"
    },
    {
      "type": "button", "id": "btn_rec", "text": "å½•éŸ³",
      "bg_color": "#e94560", "radius": 25, "w": 100, "h": 50,
      "on_press": "local://audio/cmd/record_start",
      "on_release": "local://audio/cmd/record_stop",
      "anim": {"type": "color_pulse", "color_a": "#e94560", "color_b": "#ff6b6b", "duration": 600, "repeat": -1}
    }
  ]
}
```

> **å†…å­˜å®‰å…¨ç­–ç•¥**ï¼šæ‰€æœ‰åŠ¨ç”»å±€éƒ¨æ•°æ®å‡åˆ†é…äºå †ï¼Œå¹¶ç”± `LV_EVENT_DELETE` è‡ªåŠ¨é‡Šæ”¾ï¼›image/particle ç¼“å†²å‡åˆ†é…åˆ° PSRAMï¼Œä»ä¸å ç”¨å†…éƒ¨ SRAMã€‚

---

## å››ã€ ç»ˆç«¯é…ç½‘ä¸å¼•å¯¼æµç¨‹ (SoftAP + Web Config)

ä¸ºè§£å†³ ESP32-S3 SRAM æœ‰é™å¸¦æ¥çš„é—®é¢˜å¹¶æä¾›æç®€çš„ç”¨æˆ·ä½“éªŒï¼Œç³»ç»Ÿè®¾è®¡äº†åŸºäº **åŒæ€å¯åŠ¨** ä¸ **Captive Portal** çš„é…ç½‘æµç¨‹ï¼Œç”¨äºå–ä»£ä»¥å¾€ä»£ç ç¡¬ç¼–ç ç½‘ç»œä¿¡æ¯çš„æ‰‹æ®µã€‚

### 4.1 åŒæ€å¯åŠ¨æ¨¡å‹
åœ¨ `main.c` å¼•å¯¼æ—©æœŸï¼ˆä½äº SDUI å¼•æ“åˆå§‹åŒ–ä¹‹åï¼Œä½†åœ¨éŸ³é¢‘ä¸ç½‘ç»œç­‰å¤§å†…å­˜æ¶ˆè€—å¤§æˆ·åˆ†é…ä¹‹å‰ï¼‰ï¼Œé€šè¿‡åˆ¤æ–­ NVS Storage åˆ†åŒºçš„çŠ¶æ€ï¼Œå°†è®¾å¤‡å¼•å¯¼å…¥ä¸åŒå½¢æ€ï¼š
1. **é…ç½‘æ€ (Provisioning State)**ï¼šNVS ä¸­æœªæ£€æµ‹åˆ°æœ‰æ•ˆ SSID å‡­è¯ã€‚æ­¤æ—¶ä¸å¯åŠ¨é«˜è´Ÿè½½ä¸šåŠ¡ï¼Œè€Œæ˜¯è½¬ä¸ºå¼€å¯ `SDUI-Setup` ï¼ˆå¯†ç  12345678ï¼‰çš„ Wi-Fi çƒ­ç‚¹ï¼Œå¹¶åœ¨å±å¹•æç®€æ¸²æŸ“ç›¸åº”çš„è¿ç½‘æŒ‡å¼•ã€‚
2. **æ‰˜ç®¡æ€ (Cloud State)**ï¼šæ£€æµ‹åˆ°æœ‰æ•ˆå‡­è¯ã€‚ç³»ç»ŸæŒ‰æ—¥å¸¸å…¨èƒ½çŠ¶æ€å¯åŠ¨ï¼Œæå– NVS å­˜ç•™çš„ Wi-Fi ä¸ WebSocket åœ°å€ï¼Œæ­£å¸¸è¿æ¥è¿œç«¯æœåŠ¡å™¨ã€‚

### 4.2 Captive Portal (å¼ºåˆ¶é—¨æˆ·å¼¹çª—)
åœ¨è¿›å…¥é…ç½‘æ€æ—¶ï¼Œåº•å±‚ç½‘ç»œæ¨¡å—é‡‡ç”¨äº†â€œé˜…åå³ç„šâ€çš„é©»ç•™æœåŠ¡è®¾è®¡ï¼š
- **UDP DNS åŠ«æŒ**ï¼šè¿è¡Œäºæœ¬åœ° 53 ç«¯å£ã€‚æ— è„‘å°†æ‰‹æœºæ¥å…¥çƒ­ç‚¹åå‘å‡ºçš„é’ˆå¯¹ `captive.apple.com` ç­‰æ¢æ´»åŸŸåçš„ DNS è§£æï¼Œå…¨éƒ¨åº”ç­”ä¸º ESP32 æœ¬æœºçš„ IP `192.168.4.1`ã€‚
- **HTTP 302 é‡å®šå‘**ï¼šå†…ç½®æç®€ HTTP Web Server æä¾›è‡ªé€‚åº”é…ç½®è¡¨å•ä¸»é¡µ `/`ï¼›å½“æ”¶åˆ°å…¶ä»–éšæœºçš„ HTTP GET æ¢è·¯è¯·æ±‚æ—¶ï¼Œä¸€å¾‹æ•è·å¹¶é‡å®šå‘è‡³é¦–é¡µã€‚

å½“ç”¨æˆ·åœ¨è‡ªåŠ¨å¼¹å‡ºçš„æ‰‹æœºé…ç½®è¡¨å•ä¸­ï¼Œè¾“å…¥æ‰€éœ€è¿æ¥çš„å±€åŸŸç½‘ SSIDã€å¯†ç åŠ WebSocket Server æŒ‡å‘ï¼ˆå¸¦ç«¯å£ï¼‰ç‚¹å‡»ä¿å­˜åï¼Œ**ç³»ç»Ÿå°†æŒä¹…åŒ–æ•°æ®å¹¶ç«‹å³è§¦å‘ä¸€æ¬¡ `esp_restart()` è½¯é‡å¯**ã€‚æ­¤ä¸¾æ—¢èƒ½æŒ‚è½½åº”ç”¨æ–°ç½‘ç»œé…ç½®ï¼Œäº¦èƒ½å½»åº•æ´—ç‰Œé‡Šæ”¾ SoftAP/HTTP è¿è¡ŒæœŸé—´å¸¦æ¥çš„ä¸¥é‡å†…éƒ¨ SRAM å†…å­˜ç¢ç‰‡ã€‚

---

## äº”ã€ æ ¸å¿ƒç»„ä»¶æœºåˆ¶

1. **æ¶ˆæ¯æ¢çº½ (sdui_bus)**ï¼šé‡‡ç”¨è®¢é˜…/å‘å¸ƒï¼ˆPub/Subï¼‰æ¨¡å¼ï¼Œå®ç°å„ä¸šåŠ¡è§£è€¦ã€‚æ”¯æŒä¸‰ç§è·¯ç”±æ–¹å¼ï¼šä¸‹è¡Œ (`route_down`)ã€ä¸Šè¡Œ (`publish_up`)ã€æœ¬åœ° (`publish_local`)ã€‚
2. **å¸ƒå±€å¼•æ“ (sdui_parser)**ï¼šé€’å½’è§£æ JSON UI æ ‘å¹¶æ˜ å°„ä¸º LVGL å¯¹è±¡ã€‚æ”¯æŒ Flex å¸ƒå±€ã€Action URI äº‹ä»¶ç»‘å®šã€åœ†å±å®‰å…¨è¾¹è·(40px)ã€åŠ¨ç”»ç‰¹æ•ˆé©±åŠ¨ã€‚
3. **é€šä¿¡ä¿¡ä½¿ (websocket_manager)**ï¼šæ”¯æŒæ–­çº¿è¢«åŠ¨é‡è¿ã€‚åœ¨å¼±ç½‘æ–­çº¿æ—¶ä¸»åŠ¨æ‹¦æˆªä¸Šè¡Œå‘å¸ƒï¼Œé¿å…æ•°æ®å †ç§¯å¯¼è‡´ OOMã€‚
4. **éŸ³é¢‘å…¨åŒå·¥ (audio_manager)**ï¼šæ”¯æŒåŒé€šé“éº¦å…‹é£è¯»å–ä¸åŸºäº I2S çš„ DAC éŸ³é¢‘æ’­æ”¾ã€‚é€šè¿‡æ€»çº¿äº‹ä»¶è®¢é˜…é©±åŠ¨ï¼ˆ`audio/cmd/*`ï¼‰ã€‚
5. **ç©ºé—´æ„ŸçŸ¥ (imu_manager)**ï¼šé€šè¿‡ `sdui_bus` ä¸Šè¡Œå‘å¸ƒå§¿æ€äº‹ä»¶ï¼ˆå¦‚ `motion` ä¸»é¢˜ï¼‰ï¼Œä¸ WebSocket å®Œå…¨è§£è€¦ã€‚
6. **ç½‘ç»œç®¡ç† (wifi_manager)**ï¼šå®ç°ä¸Šæ–‡æ‰€è¿°çš„åŒæ€å¼•å¯¼ç®¡æ§ï¼Œä»¥åŠ SoftAP å’Œ STA æ— çº¿åŸºç«™é“¾è·¯çš„è‡ªåŠ¨åŒ–é…ç½®ã€‚
7. **é¥æµ‹ä¸ŠæŠ¥ (telemetry_manager)**ï¼šåå°ä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆæ ˆåœ¨ PSRAMï¼‰ï¼Œæ¯ 30s é‡‡é›†ä»¥ä¸‹ä¿¡æ¯å¹¶é€šè¿‡ `sdui_bus` ä¸ŠæŠ¥ `telemetry/heartbeat` ä¸»é¢˜ï¼š
   - **`device_id`**ï¼šeFuse MAC åœ°å€ï¼ˆ6å­—èŠ‚ HEX å­—ç¬¦ä¸²ï¼‰ï¼ŒèŠ¯ç‰‡å‡ºå‚å†™å…¥ï¼Œå…¨å±€å”¯ä¸€ï¼Œä½œä¸ºæœåŠ¡ç«¯ç®¡ç†ç»ˆç«¯çš„å”¯ä¸€ Keyã€‚
   - **`wifi_rssi`**ï¼šå½“å‰å…³è” AP çš„ä¿¡å·å¼ºåº¦ï¼ˆdBmï¼‰ã€‚
   - **`ip`**ï¼šç»ˆç«¯åœ¨å±€åŸŸç½‘å†…åˆ†é…çš„ IP åœ°å€ã€‚
   - **`temperature`**ï¼šESP32-S3 å†…ç½®æ¸©åº¦ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆç²¾åº¦ Â±5Â°Cï¼‰ã€‚
   - **`free_heap_internal` / `free_heap_total`**ï¼šå†…éƒ¨ SRAM åŠæ€»å †ç©ºé—´å‰©ä½™ï¼Œå¯ç”¨äºè¿œç¨‹ç›‘æ§å†…å­˜å¥åº·ã€‚
   - **`uptime_s`**ï¼šè®¾å¤‡æŒç»­è¿è¡Œæ—¶é•¿ï¼ˆç§’ï¼‰ã€‚

---

## å…­ã€ ğŸš§ ESP32-S3 å†…éƒ¨ SRAM å†…å­˜æ²»ç†æ‰‹å†Œ (é‡è¦)

ESP32-S3 æ‹¥æœ‰ ~512KB å†…éƒ¨ SRAM å’Œ 8MB PSRAMï¼Œä½†**ä¸¤è€…å¹¶ä¸ç­‰ä»·**ï¼šSPI DMAã€FreeRTOS ä»»åŠ¡æ ˆç­‰ç¡¬ä»¶çº§æ“ä½œä¸¥æ ¼ä¾èµ–å†…éƒ¨ SRAM çš„**è¿ç»­å—**ã€‚WiFi åè®®æ ˆè¿è¡Œåä¼šå°†å†…éƒ¨ SRAM ç¢ç‰‡åŒ–ï¼Œä½¿ä¹‹å‰çœ‹ä¼¼å……è£•çš„ç©ºé—´æ— æ³•æ»¡è¶³å¤§å—è¿ç»­åˆ†é…ã€‚

æœ¬ç« è®°å½•äº† `SPI DMA Failed to allocate priv TX buffer` + `ESP_ERR_NO_MEM` çš„å®Œæ•´æ’æŸ¥è¿‡ç¨‹ï¼Œæ¶‰åŠä¸‰ä¸ªç›¸äº’å…³è”çš„å­é—®é¢˜ã€‚

### é—®é¢˜ç°è±¡

```
E spi_master: setup_dma_priv_buffer(1206): Failed to allocate priv TX buffer
E lcd_panel.io.spi: panel_io_spi_tx_color(395): spi transmit (queue) color failed
E co5300_spi: panel_co5300_draw_bitmap(292): send color data failed
E esp_lvgl:bridge_v9: Draw bitmap failed: ESP_ERR_NO_MEM
E AUDIO_MANAGER: Failed to allocate internal memory! System halted.
```

### æ ¹å› æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å†…éƒ¨ SRAM (~512KB) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WiFi åè®®æ ˆ (60-100KB, ç¢ç‰‡åŒ–)                          â”‚
â”‚  I2S DMA ç¼“å†² (~10KB)                                   â”‚
â”‚  FreeRTOS ç³»ç»Ÿæ ˆ + å„ä»»åŠ¡æ ˆ                               â”‚
â”‚  â˜… LVGL Draw Buffer (åŸ PSRAM â†’ æ”¹ä¸ºå†…éƒ¨ 9.3KB)          â”‚
â”‚  â˜… SPI DMA bounce buffer (æ¯æ¬¡ flush åŠ¨æ€ç”³è¯·,å¤§å°=ä¼ è¾“å—) â”‚
â”‚  â˜… éŸ³é¢‘å½•éŸ³ buffer (åŸå¼ºåˆ¶ INTERNAL â†’ æ”¹èµ° DEFAULT)       â”‚
â”‚  â€¦å‰©ä½™ç¢ç‰‡â€¦                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ ¸å¿ƒçŸ›ç›¾ï¼šå¤šä¸ªç»„ä»¶ç«äº‰æœ‰é™ä¸”ç¢ç‰‡åŒ–çš„å†…éƒ¨ SRAM è¿ç»­å—ã€‚

---

### ä¿®å¤ 1 â€” æ¶ˆé™¤ SPI DMA Bounce Buffer (`esp32_s3_touch_amoled_1_75c.c`)

**åŸç†**ï¼šLVGL æ¸²æŸ“ç¼“å†²åœ¨ PSRAM æ—¶ï¼ŒSPI DMA æ— æ³•ç›´æ¥è®¿é—®ï¼Œåº•å±‚é©±åŠ¨ä¼šåœ¨**æ¯æ¬¡ flush** æ—¶ä»å†…éƒ¨ SRAM åŠ¨æ€ `malloc` ä¸€å—ä¸ä¼ è¾“æ•°æ®ç­‰å¤§çš„ bounce buffer åšè·³æ¿ã€‚WiFi ç¢ç‰‡åŒ–åæ‰¾ä¸åˆ°è¿ç»­å—å³ OOMã€‚

**è§£æ³•**ï¼šè®© LVGL ç¼“å†²ç›´æ¥å¸¸é©»å†…éƒ¨ SRAMï¼ˆä¸€æ¬¡æ€§å®‰æ’ï¼Œä¸å†æ¯å¸§åŠ¨æ€ç”³è¯·ï¼‰ã€‚

```c
// bsp_display_lcd_init() ä¸­çš„å…³é”®é…ç½®
#define LVGL_TRANSFER_BUF_LINES  10  // æ¯å— 466Ã—10Ã—2 â‰ˆ 9.3KB

// SPI bus å‚æ•°
.max_transfer_sz = BSP_LCD_H_RES * LVGL_TRANSFER_BUF_LINES * BSP_LCD_BITS_PER_PIXEL / 8,
io_config.trans_queue_depth = 4;  // é™ä½é˜Ÿåˆ—æ·±åº¦

// LVGL adapter é…ç½®
.buffer_height = LVGL_TRANSFER_BUF_LINES,
.use_psram     = false,           // â† å…³é”®ï¼šç¼“å†²åœ¨å†…éƒ¨ SRAMï¼ŒSPI ç›´æ¥ DMA è®¿é—®
.require_double_buffer = false,   // å•ç¼“å†²ï¼ŒèŠ‚çœå†…éƒ¨ SRAM
```

> **ä»£ä»·**ï¼šåˆ·æ–°ç‡ç•¥é™ï¼ˆæ¯å¸§éœ€ ~47 æ¬¡ SPI ä¼ è¾“ï¼‰ã€‚å¯¹ UI æ–‡æœ¬/æŒ‰é’®ç±»åœºæ™¯å½±å“å¾®ä¹å…¶å¾®ã€‚

---

### ä¿®å¤ 2 â€” éŸ³é¢‘ç¼“å†²é‡Šæ”¾å†…éƒ¨ SRAM (`audio_manager.c`)

**åŸç†**ï¼š`audio_record_task` å’Œ `audio_play_callback` ä¸­çš„ PCM / Base64 / JSON ç¼“å†²åŸæœ¬ä½¿ç”¨ `MALLOC_CAP_INTERNAL` å¼ºåˆ¶åˆ†é…åœ¨å†…éƒ¨ SRAMï¼ˆæ€»è®¡ ~4.5KBï¼‰ï¼Œä¸ SPI DMA äº‰æŠ¢èµ„æºã€‚

**è§£æ³•**ï¼šè¿™äº›æ˜¯åº”ç”¨å±‚ç¼–è§£ç ç¼“å†²ï¼Œä¸éœ€è¦ DMA ç›´æ¥è®¿é—®ï¼Œæ”¹ç”¨ `MALLOC_CAP_DEFAULT`ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…åˆ°æœ€åˆé€‚çš„åŒºåŸŸï¼ˆPSRAM ä¼˜å…ˆï¼‰ã€‚

```c
// ä¿®æ”¹å‰ï¼ˆäº‰æŠ¢å†…éƒ¨ SRAMï¼‰
heap_caps_malloc(size, MALLOC_CAP_INTERNAL | MALLOC_CAP_8BIT);

// ä¿®æ”¹åï¼ˆæ”¾å®½åˆ°é»˜è®¤å†…å­˜æ± ï¼Œå¯åˆ†é…è‡³ PSRAMï¼‰
heap_caps_malloc(size, MALLOC_CAP_DEFAULT | MALLOC_CAP_8BIT);
```

---

### ä¿®å¤ 3 â€” éŸ³é¢‘ä»»åŠ¡æ ˆè¿ç§»è‡³ PSRAM (`audio_manager.c` + `sdkconfig.defaults`)

**åŸç†**ï¼šä¿®å¤ 1 å ç”¨äº† 9.3KB å†…éƒ¨ SRAM ç”¨äº LVGL ç¼“å†²åï¼Œ`xTaskCreatePinnedToCore` ä¸ºå½•éŸ³ä»»åŠ¡åˆ†é… 4KB æ ˆæ—¶å› å†…éƒ¨ SRAM ä¸è¶³è€Œ**é™é»˜å¤±è´¥**ï¼ˆåŸä»£ç æœªæ£€æŸ¥è¿”å›å€¼ï¼‰ï¼Œå¯¼è‡´å½•éŸ³ä»»åŠ¡ä»æœªå¯åŠ¨ã€‚

**è§£æ³•**ï¼šä½¿ç”¨ ESP-IDF v5.4+ çš„ `xTaskCreatePinnedToCoreWithCaps` APIï¼Œå°†ä»»åŠ¡æ ˆåˆ†é…åˆ° PSRAMã€‚

```c
#include "freertos/idf_additions.h"

BaseType_t ret = xTaskCreatePinnedToCoreWithCaps(
    audio_record_task, "audio_record_task",
    4096, NULL, 2, NULL, 1,
    MALLOC_CAP_SPIRAM);        // â† ä»»åŠ¡æ ˆåˆ†é…åˆ° PSRAM
if (ret != pdPASS) {
    ESP_LOGE(TAG, "Failed to create audio_record_task!");
}
```

åŒæ—¶åœ¨ `sdkconfig.defaults` ä¸­å¯ç”¨ï¼š
```
CONFIG_SPIRAM_ALLOW_STACK_EXTERNAL_MEMORY=y
```

---

### é˜²æŠ¢å çš„åˆå§‹åŒ–é¡ºåº (`main.c`)

```
1. bsp_display_start()    â† æœ€å…ˆï¼šSRAM å……è£•æ—¶é”šå®š SPI DMA + LVGL ç¼“å†²
2. LVGL UI æ„å»º            â† ç´§éšï¼šæ˜¾ç¤ºå°±ç»ªåç«‹å³æ¸²æŸ“
3. wifi_init_sta()         â† åç½®ï¼šæ­¤å SRAM è¢«ç¢ç‰‡åŒ–
4. websocket / imu / audio â† æœ€åï¼šå¤§å†…å­˜è´Ÿè½½ç»„ä»¶èµ° PSRAM
```

### æ’æŸ¥æ£€æŸ¥æ¸…å•

é‡åˆ°ç±»ä¼¼ OOM æ—¶ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºé€é¡¹æ’æŸ¥ï¼š

| # | æ£€æŸ¥é¡¹ | å‘½ä»¤/æ–¹æ³• |
|---|--------|----------|
| 1 | å¯åŠ¨æ—¶å†…éƒ¨ SRAM ä½™é‡ | `heap_caps_get_free_size(MALLOC_CAP_INTERNAL)` |
| 2 | æœ€å¤§è¿ç»­å¯ç”¨å— | `heap_caps_get_largest_free_block(MALLOC_CAP_INTERNAL)` |
| 3 | LVGL buffer æ˜¯å¦åœ¨ PSRAM | æ£€æŸ¥ `use_psram` è®¾ç½® |
| 4 | éŸ³é¢‘/WebSocket buffer æ˜¯å¦å¼ºåˆ¶ INTERNAL | grep `MALLOC_CAP_INTERNAL` |
| 5 | ä»»åŠ¡æ ˆæ˜¯å¦åˆ›å»ºæˆåŠŸ | æ£€æŸ¥ `xTaskCreate` è¿”å›å€¼ |

---

## ä¸ƒã€ ğŸš§ éŸ³é¢‘é‡‡é›†æ•°æ®é“¾è·¯é¿å‘æŒ‡å— (Stereo to Mono)

åœ¨ ESP32-S3 ä¸ ES7210 éº¦å…‹é£çš„é…åˆä½¿ç”¨ä¸­ï¼Œå¦‚æœé‡åˆ°**å½•éŸ³æåº¦æ¨¡ç³Šã€å£°éŸ³æ‹‰é•¿ã€ä¼´æœ‰ç±»ä¼¼æ’•è£‚çš„æ»‹æ»‹å£°**çš„æƒ…å†µï¼Œé™¤äº†æ’æŸ¥ PSRAM å¸¦å®½å¯¼è‡´çš„ I2S ç¼ºè½½å¤±çœŸï¼ˆè§ç¬¬å…­ç« ï¼‰å¤–ï¼Œè¿˜éœ€è¦æ’æŸ¥**å£°é“æ•°æ®é”™ä½**é—®é¢˜ã€‚

ç”±äºå®˜æ–¹ BSP å°†éº¦å…‹é£é»˜è®¤åˆå§‹åŒ–ä¸º**åŒå£°é“ï¼ˆStereoï¼‰**æ•°æ®æŠ“å–æ¨¡å¼ï¼ŒI2S è¯»å–çš„ PCM ç¼“å†²ä¸­åº•å±‚è¿ç»­æ•°æ®å…¶å®æ˜¯äº¤é”™æ’åˆ—çš„ `(Left, Right, Left, Right...)`ã€‚
è‹¥æœªåœ¨ç«¯ä¾§è¿›è¡Œåˆå¹¶é™æ··ï¼ˆDownmixï¼‰ï¼Œç›´æ¥å°†è¿™æ‰¹åŒå£°é“äº¤ç»‡æ•°æ®ä»¥ Base64 æµé€šè¿‡ç½‘ç»œä¸ŠæŠ¥ï¼Œä¸”äº‘ç«¯å•å£°é“ï¼ˆMonoï¼‰å¤„ç†æµæ°´çº¿å°†å®ƒå½“æˆçº¯ç²¹çš„å•é€šé“é‡‡æ ·æµå¼ºè¡Œå›æ”¾ï¼Œå°±ä¼šé€ æˆï¼šæ—¶é•¿æ‹‰é•¿ä¸€å€ã€å·¦å³æ³¢å½¢å‘ç”Ÿç©ºé—´äº¤é”™æŠ˜å ã€‚å¬æ„Ÿä¸Šå³è¡¨ç°ä¸ºæåº¦æ¨¡ç³Šå’Œæ’•è£‚çš„ç”µå­éŸ³ã€‚

**åº”å¯¹æ–¹æ¡ˆ**ï¼š
å·²ç»åœ¨ `audio_manager.c` çš„ `audio_record_task` è½®è¯¢ä¸­å¢åŠ äº†åŒå£°é“è½¬å•å£°é“çš„å°±åœ°é™æ··è¿ç®—ï¼šå³è®¡ç®— `(Left + Right) / 2` ä½œä¸ºçœŸæ­£çš„ç»“æœç‚¹å†å¡«å…¥å‘é€ç¼“å†²ã€‚è¿™æ ·ä¸ä»…å®Œç¾è§£å†³äº†å£°éŸ³æ‰­æ›²é—®é¢˜ï¼Œæ›´ä½¿å¾—ä¸Šè¡Œè¯­éŸ³æ•°æ®å¸§çš„ç½‘ç»œè´Ÿè·ç›´æ¥å‡åŠã€‚

---

## å…«ã€ å¿«é€Ÿä¸Šæ‰‹ä¸ç¼–è¯‘çƒ§å½•

ç”±äºæœ¬é¡¹ç›®é‡æ„è¿‡åº•å±‚ `sdkconfig.defaults` å†…å­˜é…æ¯”æ˜ å°„ï¼Œ**é¦–æ¬¡ç¼–è¯‘/æ¸…ç†åé‡æ–°ç¼–è¯‘æ—¶ï¼Œå¿…é¡»åˆ é™¤åŸç”Ÿæˆçš„é…ç½®æ–‡ä»¶**ã€‚

### å‘½ä»¤è¡Œç¼–è¯‘

```bash
# è¿›å…¥å·¥ç¨‹ç›®å½•
cd 02_lvgl_demo_v9

# 1. åˆ é™¤å†å²é…ç½®æ–‡ä»¶ï¼ˆå¼ºåˆ¶é‡æ–°åº”ç”¨ defaultsï¼‰
rm sdkconfig (Linux/macOS) æˆ– del sdkconfig (Windows)
# æˆ–è€…æ‰§è¡Œå…¨é‡æ¸…ç†
idf.py fullclean

# 2. ç¼–è¯‘å¹¶çƒ§å½•ç›‘æ§
idf.py build flash monitor
```

### VS Code æ’ä»¶å¼€å‘

1. ç‚¹å‡»åº•éƒ¨çŠ¶æ€æ çš„ `ESP-IDF: Full Clean` åƒåœ¾æ¡¶å›¾æ ‡ã€‚
2. ç‚¹å‡»é½¿è½®å›¾æ ‡ `ESP-IDF: SDK Configuration editor (menuconfig)` ç‚¹ä¸€ä¸‹ Save ç”Ÿæˆæ–°çš„ã€‚
3. ç‚¹å‡»ç«è‹—å›¾æ ‡ `ESP-IDF: Build, Flash and Monitor` è¿›è¡Œä¸€é”®æ„å»ºçƒ§å½•ã€‚

> **æç¤º**ï¼šçƒ§å½•å®Œæˆå¯åŠ¨åï¼Œè‹¥é‡åˆ°å±å¹•æ— æ³•æ­£å¸¸äº®èµ·æˆ–èŠ±å±ï¼Œè¯·æ£€æŸ¥ SPI å¼•è„šå®šä¹‰åŠä¸Šè¿° `esp32_s3_touch_amoled_1_75c.c` é©±åŠ¨ç»„ä»¶é…ç½®æ˜¯å¦è¢«æ„å¤–å›é€€ã€‚

---

## ä¹ã€ äº‘ç«¯ä¸šåŠ¡å±‚ (Python Server) MVP è¯´æ˜

é…å¥—çš„ `server.py` æ˜¯ç”¨äºè°ƒè¯•ä¸éªŒè¯ SDUI åŸå‹çš„ MVP (Minimum Viable Product) è®¾è®¡å®ç°ï¼Œæ—¨åœ¨æ¼”ç¤ºç«¯äº‘äº¤äº’çš„åŸºæœ¬é“¾è·¯ï¼Œå°šæœªè¿›è¡Œé«˜å¯ç”¨ä¸å·¥ç¨‹åŒ–å°è£…ã€‚

### æ ¸å¿ƒåŠŸèƒ½ (MVP é˜¶æ®µ)
1. **è¿æ¥å³ä¸‹å‘**ï¼šç»ˆç«¯ WebSocket è¿æ¥å»ºç«‹åï¼Œä¸»åŠ¨ä¸‹å‘é¢„è®¾çš„å®¹å™¨åŒ–é¦–å± `ui/layout`ï¼ˆåŒ…å«å¸ƒå±€ä¿¡æ¯ã€ç»„ä»¶çŠ¶æ€ï¼‰ã€‚
2. **ä¸»é¢˜äº‹ä»¶è·¯ç”±**ï¼š
   - ç›‘å¬å¹¶å¤„ç†æ¥è‡ªç»ˆç«¯çš„ `ui/click` ä¸Šè¡Œäº‹ä»¶ï¼Œä¾‹å¦‚å¤„ç†æŒ‰é’®çš„è®¡æ•°ç´¯åŠ ï¼Œå¹¶è¿”å› `ui/update` æ›´æ–°ç»„ä»¶å±•ç¤ºã€‚
   - ç›‘å¬å¹¶å¤„ç† `audio/record` çš„éŸ³é¢‘æµï¼Œæ‰§è¡Œæœ¬åœ°å­˜å‚¨ `debug_recv.wav` ä»¥åŠåŸºç¡€çš„ Speech-To-Text (STT) è¯†åˆ«ã€‚
   - å¤„ç†ç»ˆç«¯ä¼ æ„Ÿå™¨äº‹ä»¶å¦‚ `motion` (æ‘‡ä¸€æ‘‡)ï¼Œè§¦å‘ UI æˆ–é€»è¾‘çš„å˜åŠ¨ã€‚
   - ç›‘å¬ `telemetry/heartbeat` äº‹ä»¶ï¼Œå¯å®æ—¶æŸ¥çœ‹ç»ˆç«¯è®¾å¤‡çš„å†…å­˜åˆ†é…åŠç½‘ç»œæ¢é’ˆçŠ¶å†µã€‚
3. **Debug è°ƒè¯•æ§åˆ¶å°**ï¼šåœ¨å‘½ä»¤è¡Œæä¾›äº†ä¸€å¥—æç®€çš„æ‰‹åŠ¨æ“ä½œå°ï¼Œæ–¹ä¾¿å¼€å‘è€…åœ¨è”æœºè¿è¡Œæ—¶ä¸‹å‘ `layout` (é‡ç½®å¸ƒå±€) / `update` (æ›´æ–°ç»„ä»¶) / `raw` (åŸå§‹æŒ‡ä»¤) ä»¥è¾…åŠ©ç¡¬ä»¶ä¾§ç•Œé¢çš„è°ƒè¯•ã€‚

### åç»­æ¼”è¿›æ–¹å‘
ç›®å‰çš„ Server ä»…ç”¨äºå•å®ä¾‹éªŒè¯ï¼Œè¦æ”¯æŒå¤æ‚çš„ Agent ä¸šåŠ¡éœ€è¦åç»­æ‰©å±•ï¼š
- å¼•å…¥ FastAPI / å¼‚æ­¥æ¡†æ¶å¹¶ç»“åˆå¤šå®ä¾‹ Session ç®¡ç†ï¼ˆè€Œéç°æœ‰çš„å…¨å±€å•ä¸€è¿æ¥å˜é‡ï¼‰ã€‚
- å°† STT æ¨¡å—åŠéŸ³é¢‘ä¸‹å‘ï¼ˆTTSï¼‰å¯¹æ¥åˆ°çœŸæ­£çš„å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æµå¼æ¥å£ã€‚
- åˆ†ç¦»çŠ¶æ€åŒæ­¥ï¼ˆåŠ å…¥ version/nonce æ§åˆ¶æœºåˆ¶ï¼‰åŠèµ„æºä¸‹å‘é€»è¾‘ã€‚
